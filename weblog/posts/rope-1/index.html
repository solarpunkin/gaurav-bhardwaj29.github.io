<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="../../weblog-style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      if (window.renderMathInElement) {
        renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
          ]
        });
      }
    });
  </script>
  <title>rope</title>
</head>
<body>
  <div class="weblog-post">
    <h1>rope</h1>
    <div class="weblog-meta">
      <span class="weblog-date">2025-09-05</span>
      <span class="weblog-tags">
        <a href="../../tags/msl.html" class="weblog-tag">msl</a><a href="../../tags/C++.html" class="weblog-tag">C++</a><a href="../../tags/python.html" class="weblog-tag">python</a><a href="../../tags/gpu.html" class="weblog-tag">gpu</a>
      </span>
    </div>
    <div class="weblog-content">
      <p>RoPE (Rotary Positional Embeddings) introduces an innovative concept of applying rotation to word vectors, rather than adding position vectors. For example, in order to encode the position of this vector in a sentence with a two-dimensional vector of the word "dog", RoPE rotates this vector. The rotation angle (theta) is proportional to the position of the word in the sentence. As an example, rotate the vector at the theta in the first position, at 2 theta in the second position, and so on. This provides a more natural way to represent sequential information. </p>
<aside>
üí°
This is an implementation of RoPE as discussed in EleutherAI's blog post titled Rotary Embeddings: A Relative Revolution by Biderman et al. (2021).

</aside>

<figure style="text-align: center; margin: 2rem 0;">
  <iframe 
    src="https://blog.eleuther.ai/images/blog/rotary-embeddings/waveplate.html" 
    style="width: 100%; height: 500px; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
    title="Interactive Waveplate Demo">
  </iframe>
  <figcaption style="margin-top: 0.8rem; font-size: 0.9em; color: var(--muted);">
    Interactive waveplate visualization. Try dragging the cube to rotate the view!
  </figcaption>
</figure>

<div class="codehilite-container codehilite"><div class="code-toolbar">
    <span class="language-name"></span>
    <button class="copy-btn" onclick="copyCode(this, 'code-block-443019')" aria-label="Copy code to clipboard">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    </button>
    <a class="anchor-link" href="#code-block-443019" aria-label="Link to this code block">üîó</a>
</div><pre id="code-block-443019"><span></span><code><span class="k">def</span> <span class="nf">rope</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="c1"># theta: (1, seq_len, 1) ‚Äî angle per position</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span> <span class="c1"># (batch, seq_len, dim) per attn head H</span>
    <span class="k">assert</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># even dims</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># odd dims</span>

    <span class="n">sin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="n">x_rotated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">x1</span> <span class="o">*</span> <span class="n">cos</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">sin</span><span class="p">,</span>
        <span class="n">x1</span> <span class="o">*</span> <span class="n">sin</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">cos</span>
    <span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_rotated</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (batch, seq_len, dim)</span>
</code></pre></div>

<ul>
<li>Equivalent pytorch code (if you prefer summation and q, m are known). Note that equivalence here is referred to simplicity and flexibility and does not guarantee efficiency, especially when training large deep neural nets from scratch.</li>
</ul>
<div class="codehilite-container codehilite"><div class="code-toolbar">
    <span class="language-name"></span>
    <button class="copy-btn" onclick="copyCode(this, 'code-block-26bbfd')" aria-label="Copy code to clipboard">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    </button>
    <a class="anchor-link" href="#code-block-26bbfd" aria-label="Link to this code block">üîó</a>
</div><pre id="code-block-26bbfd"><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="k">def</span> <span class="nf">apply_rope</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="c1"># q: (d,), thetas: (d//2,), m: scalar</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># (d/2, 2)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">thetas</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="n">rot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">cos</span><span class="p">,</span> <span class="o">-</span><span class="n">sin</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">sin</span><span class="p">,</span>  <span class="n">cos</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (d/2, 2, 2)</span>

    <span class="n">q_rotated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bij,bj-&gt;bi&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>  <span class="c1"># (d/2, 2)</span>
    <span class="k">return</span> <span class="n">q_rotated</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</code></pre></div>

<figure style="text-align: center;">
  <img src="https://pub-91e1a485198740aabff1705e89606dc3.r2.dev/rope_rotation_demo.gif" style="max-width: 100%; height: auto;" />
  <figcaption></figcaption>
</figure>

<h2>Fused RoPE kernel in metal</h2>
<p>The implementation uses a fused kernel approach where each thread processes one rotation pair (even/odd elements), achieving optimal GPU utilization and memory coalescing. </p>
<div class="codehilite-container codehilite"><div class="code-toolbar">
    <span class="language-name"></span>
    <button class="copy-btn" onclick="copyCode(this, 'code-block-9e8128')" aria-label="Copy code to clipboard">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    </button>
    <a class="anchor-link" href="#code-block-9e8128" aria-label="Link to this code block">üîó</a>
</div><pre id="code-block-9e8128"><span></span><code><span class="n">kernel</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fused_rope</span><span class="p">(</span>
<span class="w">    </span><span class="n">device</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="w">     </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">device</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">cos_table</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">device</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">sin_table</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">device</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w">       </span><span class="n">output</span><span class="w">    </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">constant</span><span class="w"> </span><span class="n">uint</span><span class="o">&amp;</span><span class="w">      </span><span class="n">S</span><span class="w">         </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">constant</span><span class="w"> </span><span class="n">uint</span><span class="o">&amp;</span><span class="w">      </span><span class="n">B</span><span class="w">         </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">constant</span><span class="w"> </span><span class="n">uint</span><span class="o">&amp;</span><span class="w">      </span><span class="n">H</span><span class="w">         </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">constant</span><span class="w"> </span><span class="n">uint</span><span class="o">&amp;</span><span class="w">      </span><span class="n">D</span><span class="w">         </span><span class="p">[[</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">]],</span>
<span class="w">    </span><span class="n">uint3</span><span class="w"> </span><span class="n">gid</span><span class="w">                   </span><span class="p">[[</span><span class="w"> </span><span class="n">thread_position_in_grid</span><span class="w"> </span><span class="p">]])</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gid</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">total_elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">total_elements</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">half_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">d_pair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">half_d</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">half_d</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">H</span><span class="p">;</span>
<span class="w">    </span><span class="n">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">H</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>

<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">base_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">H</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>

<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">even_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d_pair</span><span class="p">;</span>
<span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">odd_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d_pair</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x_even</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">even_idx</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x_odd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">[</span><span class="n">odd_idx</span><span class="p">];</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">cos_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos_table</span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">half_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d_pair</span><span class="p">];</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">sin_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin_table</span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">half_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">d_pair</span><span class="p">];</span>

<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">even_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_even</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x_odd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin_val</span><span class="p">;</span>
<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">odd_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_even</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sin_val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x_odd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cos_val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>When dispatching threads , dispatch with (S * B * H * D/2) threads in the x-dimension</p>
<p><code>MTLSize threadsPerGrid = MTLSizeMake(S * B * H * (D/2), 1, 1);</code></p>
<aside>
üöß

Ongoing Work is focussed in benchmarking the kernel against rope implementations from huggingface transformers, xFormers, and flash attention 2 CUDA on Latency, Memory usage, FLOPs, numerical accuracy etc. 

</aside>

<p>Until then‚Ä¶ heavy caffeine ‚òïÔ∏è and peace ‚òÆÔ∏è</p>
<script>
function copyCode(button, preId) {
    const preElement = document.getElementById(preId);
    if (preElement) {
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return;
        const codeText = codeElement.innerText;
        navigator.clipboard.writeText(codeText).then(() => {
            const originalContent = button.innerHTML;
            button.innerHTML = 'Copied!';
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy code: ', err);
            const originalContent = button.innerHTML;
            button.innerHTML = 'Error!';
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 2000);
        });
    }
}
</script>
    </div>
    <div class="weblog-footer">
      <a href="../../" class="weblog-back">‚Üê Back to all posts</a>
    </div>
  </div>
  
<script>
function copyCode(button, preId) {
    const preElement = document.getElementById(preId);
    if (preElement) {
        const codeElement = preElement.querySelector('code');
        if (!codeElement) return;
        const codeText = codeElement.innerText;
        navigator.clipboard.writeText(codeText).then(() => {
            const originalContent = button.innerHTML;
            button.innerHTML = 'Copied!';
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy code: ', err);
            const originalContent = button.innerHTML;
            button.innerHTML = 'Error!';
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 2000);
        });
    }
}
</script>
</body>
</html>